name: Trigger Colab Notebook with GPU Retry

on:
  schedule:
    - cron: "0 6 * * *"  # daily at 6 AM UTC
  workflow_dispatch:

jobs:
  trigger_colab:
    runs-on: ubuntu-latest
    steps:
      - name: Retry Colab until GPU is available
        env:
          NOTEBOOK_URL: "https://colab.research.google.com/drive/1SeHbsZmIc_BCX8Keiu5lz3NvRbTI2XBv"
          BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
        run: |
          MAX_RETRIES=5
          RETRY_DELAY=600  # 10 minutes
          count=0

          while [ $count -lt $MAX_RETRIES ]; do
            echo "üöÄ Attempt $((count+1)) to trigger Colab notebook..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "https://chrome.browserless.io/content?token=${BROWSERLESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"url\": \"${NOTEBOOK_URL}\"}")

            if [ "$RESPONSE" -eq 200 ]; then
              echo "‚úÖ Notebook triggered successfully"
              break
            else
              echo "‚ö†Ô∏è Trigger failed or GPU not available, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
              count=$((count+1))
            fi
          done

          if [ $count -eq $MAX_RETRIES ]; then
            echo "‚ùå All retries failed. GPU may not be available."
            exit 1
          fi
